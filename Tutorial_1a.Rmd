---
title: "Tutorial_1a"
author: "Sven Panis"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This Tutorial_1a file wrangles raw data from Experiment 1 of Panis and Schmidt (2016), and illustrates how to use functional programming to set up life tables, and plot the discrete-time hazard, survivor, and conditional accuracy functions, when there is one independent variable.

# Load the libraries that we will be using. 

```{r load-pkg, results='hide'}
pkg <- c("tidyverse", "patchwork")

lapply(pkg, library, character.only = TRUE)
```

# Read in the raw data from Panis and Schmidt (2016) - can be skipped.

```{r read-raw-data}
raw <- read_delim(file="Tutorial_1_descriptive_stats/data/DataExp1_6subjects.txt", delim="\t",col_names=T) # 9372 rows
head(raw)
#tail(raw)
#glimpse(raw)
```

# Do some wrangling to get a simpler data set - can be skipped.

```{r wrangle-raw-data}
# remove practice trials
data <- raw %>% filter(practice==0) # 9240 experimental trials: 6 participants x 70 blocks x 22 trials-per-block

# remove unnecessary columns
data <- data %>% select(-c(ss,practice,rd,form,task,primeduration,
                                             blankduration,maskduration,targetduration,
                                             void,target_dir,corresp,resperr))
# look at trials where resp==0
data %>% filter(resp==0) 
data %>% filter(resp==0) %>% print(n=51)

# remove trials with no response info if rt < 800 (800 was the response deadline in each trial):
# the 46 trials where rt >= 800 and resp==0 are trials in which the subject did not respond; these should not be deleted because they will be treated as right-censored observations in EHA!
# the remaining 5 trials of subject 1 should be removed (for some technical reason the resp (1 or 2) was not recorded; perhaps (s)he pressed both buttons at the same time...)
sel = which(data$resp==0 & data$rt < 800)
data <- data[-c(sel),] # 9235 rows

# keep only the no-mask trials
data <- data %>% filter(mask_type == 0) %>%
                 select(-mask_type) # 2757 rows and 8 variables
summary(data)
# vp = Versuchsperson or subject
# bl = block number
# tr = trial number within block
# prime_type: no prime or blank (0), consistent prime (1), inconsistent prime (2)
# resp = no button (0), button left (1), button right (2) 
# respac = accuracy
# rt = response time
# TrialNr = trial number within experiment
```

```{r save-data-file}
# save wrangled data file
write_csv(data, "Tutorial_1_descriptive_stats/data/DataExp1_6subjects_wrangled.csv")
```

# Read in simpler data file, change variable names, and create factors.

```{r read-wrangled-data}
data_wr <- read_csv("Tutorial_1_descriptive_stats/data/DataExp1_6subjects_wrangled.csv")
head(data_wr)

# change some variable names to required names (pid, trial, condition, rt, and acc)
colnames(data_wr) <- c("pid","bl","tr","condition","resp","acc","rt","trial") 
# pid to indicate column with unique person IDs
# trial must be a unique trial number per subject
# condition must be a factor indicating the levels (1,2,...) and labels of the single independent variable 
# rt to indicate column with response times (in ms)
# acc to indicate column with accuracies (1/0)

# create factor for condition (prime type)
data_wr <- data_wr %>% mutate(condition = condition + 1,
                              condition = factor(condition, levels = c(1,2,3), labels = c("blank","congruent","incongruent")))
summary(data_wr)
```

# Apply functional programming to set up life tables, and plot the discrete-time functions (h(t), S(t), and ca(t)).

Load our custom functions. Make sure you specify the same levels and labels for factor condition in the function plot_eha (line 118 in custom_functions.R) as above (line 88 in Tutorial_1a).

```{r load-functions}
source("custom_functions.R")
```

Apply the custom functions

```{r apply-functions}
# create a dataframe with two columns (pid and data); the latter contains a list of nested data frames
data_nested <- data_wr %>% group_nest(pid)
# apply the functions using map() and map2()
data_final <- data_nested %>% 
                     mutate(censored  = map(data, censor, 600, 40)) %>%   # ! user input: censoring time, and bin width
                     mutate(ptb_data  = map(censored, ptb)) %>%           # create person-trial-bin dataset
                     mutate(lifetable = map(ptb_data, setup_lt)) %>%      # create life tables without ca
                     mutate(condacc   = map(censored, calc_ca)) %>%       # calculate ca
                     mutate(lifetable_ca = map2(lifetable, condacc, join_lt_ca)) %>%    # create life tables with ca
                     mutate(plot      = map2(.x = lifetable_ca, .y = pid, plot_eha,1))  # create plots 
```

# Extract info, save plot for each subject, save a lifetable, create and save the person-trial-bin oriented data file for hazard modeling, and a data file for ca(t) modeling.

```{r extract-info, warning=F}
# view original data (column 2) for subject 1:
pluck(data_final, 2, 1) %>% print(n=20)

# view person-trial-bin data set (column 4) for subject 1:
pluck(data_final,4,1) %>% print(n=30)

# view lifetable (column 7) for each condition for subject 1
pluck(data_final, 7, 1) %>% filter(condition=="blank")
pluck(data_final, 7, 1) %>% filter(condition=="congruent")
pluck(data_final, 7, 1) %>% filter(condition=="incongruent")

# view plot (column 8) for subject 1. 
pluck(data_final, 8, 6)

# view the median RTs in a tibble (median_tb)
median_bin <- map(data_final$lifetable_ca, extract_median)
binsize    <- data_final$censored[[1]] %>% pull(bin_width) %>% max(na.rm=T)
median_rt  <- modify_depth(median_bin,1,~.x*binsize)
median_tb  <- map(median_rt, ~as_tibble(., rownames = "condition")) %>% list_rbind(names_to = "pid")
median_tb
```

```{r save-plots, eval=F}
# save the plot for each subject
map2(paste0("Tutorial_1_descriptive_stats/figures/Plot_for_subject", data_final$pid, "_PanisSchmidt.png"), data_final$plot, ggsave, width = 6, height = 8, dpi = 600)
```

Create a life table.

```{r create-single-lifetable}
# get the binsize in ms
binsize    <- data_final$censored[[1]] %>% pull(bin_width) %>% max(na.rm=T)
# extract the lifetable (column 7 in data_final) for condition 1 (neutral) for subject 6
lifetable_blank_s6 <- data_final[[7]][[6]] %>% 
                        filter(condition=="blank") %>% 
                        mutate(bin = period*binsize,
                               events = event1) %>%
                        select(bin,risk_set,events,hazard,se_haz,survival,se_surv,ca,se_ca) 
# get riskset for first bin
riskset <- lifetable_blank_s6 %>% select(risk_set) %>% slice(1) %>% pull()

# create a row for time point 0
row0 <- c(bin=0,risk_set=riskset,events=NA,hazard=NA,se_haz=NA,survival=1,se_surv=0,ca=NA,se_ca=NA)
# add new row
lifetable_blank_s6_complete <- lifetable_blank_s6 %>%
                                 add_row(!!! row0) %>%
                                 arrange(bin)
lifetable_blank_s6_complete
```

```{r save-single-lifetable, eval=F}
write_csv(lifetable_blank_s6_complete, file="Tutorial_1_descriptive_stats/tables/lifetable_neutral_s6.csv")
```

Create input file for hazard models.

```{r create-file-hazard-modeling}
# select the person-trial-bin data set for each subject, unnest them, and select relevant variables.
input_modeling_hazard <- data_final %>% 
                         select(pid, ptb_data) %>%  unnest(ptb_data) %>%
                         select(pid,bl,tr,trial,condition,period,event)
summary(input_modeling_hazard)
```

```{r save-file-hazard-modeling, eval=F}
write_csv(input_modeling_hazard, file="Tutorial_1_descriptive_stats/data/inputfile_hazard_modeling.csv")
```

Create input file for ca(t) models.

```{r create-file-ca-modeling}
# select the censored data set for each subject, unnest them, discard trials that are censored (RT > 600 or no response detected before the deadline), and select relevant variables. 
input_modeling_ca <- data_final %>%
                     select(pid, censored) %>% unnest(censored) %>%
                     filter(right_censored == 0) %>% # only keep uncensored trials
                     select(pid,bl,tr,trial,condition,acc,drt)
```

```{r save-file-ca-modeling, eval=F}
write_csv(input_modeling_ca, file="Tutorial_1_descriptive_stats/data/inputfile_ca_modeling.csv")
```

# Optional: Create single plot for data aggregated across subjects. This is only recommended when all subjects show the same qualitative patterns.

```{r agg-data}
# create single subject number, and unique trial number
data_agg <- data_wr %>% mutate(oldtrial=trial,
                               oldpid=pid,
                               trial = 1:n(),
                               pid = 1)
```

```{r agg-descr}
# apply functions
data_agg_nested <- data_agg %>% group_nest(pid)
data_agg_final <- data_agg_nested %>% 
                     mutate(censored  = map(data, censor, 600, 40)) %>%   # ! user input: censoring time, and bin width
                     mutate(ptb_data  = map(censored, ptb)) %>%           # create person-trial-bin dataset
                     mutate(lifetable = map(ptb_data, setup_lt)) %>%      # create life tables without ca
                     mutate(condacc   = map(censored, calc_ca)) %>%       # calculate ca
                     mutate(lifetable_ca = map2(lifetable, condacc, join_lt_ca)) %>%    # create life tables with ca
                     mutate(plot      = map2(.x = lifetable_ca, .y = pid, plot_eha_agg,1))  # create plots 
```

```{r agg-plot, warning=F}
# view plot
pluck(data_agg_final, 8, 1)
```

