---
title: "Tutorial_2"
author: "Sven Panis"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

In this file we build a Bayesian hazard regression model for the first experiment of Panis and Schmidt (2016) using only the no-mask trials (prime = blank, congruent, or incongruent), and visualize the posterior distributions.

# Load the libraries that we will be using

```{r load-pkg}
pkg <- c("cmdstanr", "standist", "tidyverse", "RColorBrewer", "patchwork", 
         "brms", "tidybayes", "bayesplot", "future", "parallel")

lapply(pkg, library, character.only = TRUE)
```

# Set options. 

```{r set-options}
options(brms.backend = "cmdstanr",
        mc.cores = parallel::detectCores(),
        future.fork.enable = TRUE,
        future.rng.onMisuse = "ignore") ## automatically set in RStudio

supportsMulticore()
detectCores()
```

```{r check-info}
packageVersion("cmdstanr")
devtools::session_info("rstan")
```

# Load the person-trial-bin data set that we saved in Tutorial 1.

```{r load-data}
ptb_data <- read_csv("Tutorial_1_descriptive_stats/data/inputfile_hazard_modeling.csv")
print(ptb_data,n=30)
summary(ptb_data) # 26602 rows: 6 participants, trial, 3 conditions, 15 periods, and event indicator (0/1)
```

# Prepare the data set.

```{r prepare-data}
# select analysis time range: (200,600] with 10 bins (time bin ranks 6 to 15)
ptb_data <- ptb_data %>% filter(period > 5)

# create factor condition, with "blank" as the reference level
ptb_data <- ptb_data %>% mutate(condition = factor(condition, labels = c("blank", "congruent","incongruent")))
summary(ptb_data)

# center discrete TIME (period) on bin 9, and trial on trial 1000
ptb_data <- ptb_data %>% mutate(period_9 = period - 9,
                                trial_c = (trial - 1000)/1000)

# remove unnecessary columns before fitting a model
ptb_data <- ptb_data %>% select(-c(bl,tr,trial,period)) # 12840 obs. of 5 variables
head(ptb_data,n=17)
summary(ptb_data)
# 6 subjects
# condition: blank (6401), congruent (2642), incongruent (3797)
# period_9: -3 to 6
# trial_c: -0.999 to 0.540
```

# Set up priors, and fit the model with full random effects structure.

```{r priors}
priors <- c(
  set_prior("normal(0, 1)", class = "b"), # for beta parameters when using logit link
  
  #set_prior("skew_normal(-0.5, .95,-4)", class = "b"), # for beta parameters when using cloglog link
  
  set_prior("student_t(7.61, 0, 1.57)", class = "b", coef = "Intercept"), # flat prior for intercept on hazard scale when using logit link; 
  
  #set_prior("skew_normal(-1,1,-2)", class = "b", coef = "Intercept"),   # weakly regularizing prior for intercept when using cloglog link (hazard values below .5 more likely than values above .5)
  set_prior("normal(0, 1)", class = "sd"), # for standard deviation of RE
  set_prior("lkj(2)", class = "cor") # for correlations between RE
)

inv_cloglog <- function(c){
  1-exp(-exp(c))
}
cloglog <- function(p){
  log(-log(1-p))
}

dat <- 
  tibble(c1 = rnorm(1e5,0,1), # usa as weakly reguralizing prior for beta parameters (when using logit link)
         c2 = rt(1e5,7.61)* 1.57) %>% # use as weakly reguralizing prior for interceptparameter (when using logit 
  mutate(p1 = inv_logit_scaled(c1),
         p2 = inv_logit_scaled(c2)) 

plot(density(dat$c1))
plot(density(dat$c2))
plot(density(dat$p1))
plot(density(dat$p2))

# cloglog
dat2 <- tibble(c1 = rnorm(1e5,-1,1.1), # cloglog intercept
              c2 = rskew_normal(1e5, -0.5, sigma = .95, alpha = -4)) %>% # beta toward .6
 
  mutate(p1 = inv_cloglog(c1),
         p2 = inv_cloglog(c2)) 


plot(density(dat2$c1))
plot(density(dat2$c2))
plot(density(dat2$p1))
plot(density(dat2$p2))



```

```{r full-random-effects-model}
plan(multicore)

model_full_RE_newprior <-
   brm(data = ptb_data,
       family = binomial(link="cloglog"),
       event | trials(1) ~ 0 + Intercept + 
                           condition*period_9*trial_c + 
                           condition*I(period_9^2) + 
                           condition*I(period_9^3) +
                           (1 + condition*period_9*trial_c +
                           condition*I(period_9^2) +
                           condition*I(period_9^3) | pid),
       prior = priors,
       chains = 4, cores = 4, iter = 3000, warmup = 1000,
       control = list(adapt_delta = 0.999, step_size = 0.04, max_treedepth = 12),
       seed = 12, init = "0",
       file = "Tutorial_2_Bayesian/models/model_full_RE_newprior")

# the formula above comes down to the following effects:
# cloglog[h(t)]=Intercept+ ##the estimated cloglog[h(t)] in bin 9 for trial 1000 for reference condition "blank"
# period_9+I(period_9^2)+I(period_9^3)+ ##a cubic specification of TIME for reference condition "blank"
# congruent+congruent:period_9+congruent:I(period_9^2)+congruent:I(period_9^3)+ ##effect of congruent interacts cubicly with TIME
# incongruent+incongruent:period_9+incongruent:I(period_9^2)+incongruent:I(period_9^3)+ ##effect of incongruent interacts cubicly with TIME
# trial_c + trial_c:period_9 + ##linear effect of trial number in bin 9 can change linearly over TIME for "blank"
# trial_c:congruent + trial_c:incongruent + ##linear effect of trial number in bin 9 can differ for congruent and incongruent
# trial_c:congruent:period_9 + trial_c:incongruent:period_9 ##how the linear effect of trial number changes linearly over TIME can differ for congruent and incongruent
```

Model_full_RE took between 3 and 4 hours to run.

```{r check-model-full-RE}
summary(model_full_RE)
```

Fit a model that relaxes proportionality assumption.

```{r}
# remove unnecessary columns before fitting a model
ptb_data <- ptb_data %>% select(-c(trial_c)) # 12840 obs. of 4 variables
head(ptb_data,n=17)
summary(ptb_data)
```

```{r cubic-random-effects-model}
plan(multicore)

model_cubic_RE <-
   brm(data = ptb_data,
       family = binomial(link="cloglog"),
       event | trials(1) ~ 0 + Intercept + 
                           condition*period_9 + 
                           condition*I(period_9^2) + 
                           condition*I(period_9^3) +
                           (1 + condition*period_9 +
                           condition*I(period_9^2) +
                           condition*I(period_9^3) | pid),
       prior = priors,
       chains = 4, cores = 4, iter = 3000, warmup = 1000,
       control = list(adapt_delta = 0.999, step_size = 0.04, max_treedepth = 12),
       seed = 12, init = "0",
       file = "Tutorial_2_Bayesian/models/model_cubic_RE")

# the formula above comes down to the following effects:
# cloglog[h(t)]=Intercept+ ##the estimated cloglog[h(t)] in bin 9 for trial 1000 for reference condition "blank"
# period_9+I(period_9^2)+I(period_9^3)+ ##a cubic specification of TIME for reference condition "blank"
# congruent+congruent:period_9+congruent:I(period_9^2)+congruent:I(period_9^3)+ ##effect of congruent interacts cubicly with TIME
# incongruent+incongruent:period_9+incongruent:I(period_9^2)+incongruent:I(period_9^3) ##effect of incongruent interacts cubicly with TIME
```

```{r check-model-cubic-RE}
summary(model_cubic_RE)
```

#### relax all ass

```{r cubictime-quadtrial-model}
plan(multicore)

model_cubictime_quadtrial <-
   brm(data = ptb_data,
       family = binomial(link="cloglog"),
       event | trials(1) ~ 0 + Intercept + 
                           condition*period_9*trial_c + 
                           condition*period_9*I(trial_c^2) + 
                           condition*I(period_9^2)*trial_c + 
                           condition*I(period_9^2)*I(trial_c^2) +
                           condition*I(period_9^3) +
                      (1 + condition*period_9*trial_c +
                           condition*period_9*I(trial_c^2) +
                           condition*I(period_9^2)*trial_c +
                           condition*I(period_9^2)*I(trial_c^2) +
                           condition*I(period_9^3) | pid),
       prior = priors,
       chains = 4, cores = 4, iter = 3000, warmup = 1000,
       control = list(adapt_delta = 0.999, step_size = 0.04, max_treedepth = 12),
       seed = 12, init = "0",
       file = "Tutorial_2_Bayesian/models/model_cubictime_quadtrial")

# the formula above comes down to the following effects:
# cloglog[h(t)]=Intercept+ ##the estimated cloglog[h(t)] in bin 9 for trial 1000 for reference condition "blank"
# period_9+I(period_9^2)+I(period_9^3)+ ##a cubic specification of TIME for reference condition "blank"
# congruent+congruent:period_9+congruent:I(period_9^2)+congruent:I(period_9^3)+ ##effect of congruent interacts cubicly with TIME
# incongruent+incongruent:period_9+incongruent:I(period_9^2)+incongruent:I(period_9^3)+ ##effect of incongruent interacts cubicly with TIME
# trial_c + trial_c:period_9 + ##linear effect of trial number in bin 9 can change linearly over TIME for "blank"
# trial_c:congruent + trial_c:incongruent + ##linear effect of trial number in bin 9 can differ for congruent and incongruent
# trial_c:congruent:period_9 + trial_c:incongruent:period_9 ##how the linear effect of trial number changes linearly over TIME can differ for congruent and incongruent
```



# plot hazard functions

```{r}
model_full_RE <- readRDS("Tutorial_2_Bayesian/models/model_full_RE.rds") 
model_full_RE_newprior <- readRDS("Tutorial_2_Bayesian/models/model_full_RE_newprior.rds") 
fixef(model_full_RE)
fixef(model_full_RE_newprior)
```


# visualize posterior distributions of the effects of congruent and incongruent primes on hazard relative to blank prime, for each time bin in trial 1000, and for each time bin in trial 100.

```{r load-model}
model_full_RE <- readRDS("Tutorial_2_Bayesian/models/model_full_RE.rds") 
```

```{r make-plot-effects}
post <-as_draws_df(model_full_RE) %>% # 8000 draws x 299 variables
   select(starts_with("b_")) %>%       # 8000 x 18
   expand_grid(period_9 = -3:6) %>%   
   mutate(period_9sq = period_9^2,
          period_9cu = period_9^3,
          trial100 = -900/1000)  
# effects for trial 1000
p1congruent <- post %>% 
  mutate(postdistr = b_conditioncongruent + period_9 * `b_conditioncongruent:period_9` + period_9sq * `b_conditioncongruent:Iperiod_9E2` + period_9cu * `b_conditioncongruent:Iperiod_9E3`) %>%
  group_by(period_9) %>%
  
  ggplot(aes(x = period_9, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:6), labels=c(((-3:6)+9)*40),
                     limits = c(-3,6)) +
  scale_y_continuous(breaks = c(-6,-4,-2,0,2,4,6), limits = c(-6,6)) +
  labs(title = "trial 1000", x = "time bin", y = "effect of congruent") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 

p2incongruent <- post %>% 
  mutate(postdistr = b_conditionincongruent + period_9 * `b_conditionincongruent:period_9` + period_9sq * `b_conditionincongruent:Iperiod_9E2` + period_9cu * `b_conditionincongruent:Iperiod_9E3`) %>%
  group_by(period_9) %>%
  
  ggplot(aes(x = period_9, y = postdistr)) +
  stat_lineribbon(show.legend=F) +
  scale_fill_brewer() +
  geom_hline(yintercept=0, linetype="dashed", color = "red") +
  scale_x_continuous(breaks = c(-3:6), labels=c(((-3:6)+9)*40),
                     limits = c(-3,6)) +
  scale_y_continuous(breaks = c(-6,-4,-2,0,2,4,6), limits = c(-6,6)) +
  labs(x = "time bin", y = "effect of incongruent") +
  theme(panel.grid = element_blank(),
        axis.text.x = element_text(angle=90)) 






p1congruent + p2incongruent
#(p1+p2+p3)/(p4+p5+p6)/(p7+p8+p9)/(p10+p11+p12)/(p13+p14+p15)
```

```{r save-plot-effects}
ggsave("figures/effects_knot_1.png", width = 12, height = 16, dpi = 600)

```


